<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBT - SMKN 1 Maluku Tengah</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;450&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0B3C5D; --secondary: #1F77B4; --accent: #F39C12; --bg: #f0f2f5;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); color: #1a1a1a; overflow-x: hidden; }
    
    /* Login & UI Styling */
    .login-box { max-width: 450px; margin: 80px auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-top: 6px solid var(--accent); }
    .school-logo { width: 100px; display: block; margin: 0 auto 20px; }
    
    .header-exam { background: var(--primary); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 4px solid var(--accent); }
    .timer-badge { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 50px; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); }

    .question-card { background: white; padding: 30px; border-radius: 16px; margin: 30px auto; max-width: 850px; box-shadow: 0 8px 25px rgba(0,0,0,0.05); }
    .option-item { border: 2px solid #eef0f2; border-radius: 12px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; }
    .option-item:hover { background: #f0f7ff; border-color: var(--secondary); }
    .option-item.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: 450; }
    
    .btn-action { border-radius: 12px; padding: 12px 30px; font-weight: bold; transition: 0.3s; }
    .btn-primary { background: var(--primary); border: none; }
    .btn-primary:hover { background: var(--secondary); transform: translateY(-2px); }

    /* Responsive Font */
    @media (max-width: 576px) {
      .header-title { font-size: 0.9rem; }
      #timer { font-size: 0.9rem; }
      .question-card { padding: 20px; margin: 15px; }
    }
  </style>
</head>
<body>

<div id="loginPage" class="container">
  <div class="login-box text-center">
    <img src="https://via.placeholder.com/120?text=SMKN1" alt="Logo SMKN 1 Malteng" class="school-logo">
    <h4 class="fw-bold mb-1">SMK NEGERI 1</h4>
    <p class="text-muted small mb-4">MALUKU TENGAH</p>
    <div class="mb-3 text-start">
      <label class="small fw-bold">Nama Lengkap Siswa</label>
      <input type="text" id="username" class="form-control p-3" placeholder="Masukkan Nama">
    </div>
    <div class="mb-4 text-start">
      <label class="small fw-bold">Password</label>
      <input type="password" id="password" class="form-control p-3" placeholder="Default: 1234">
    </div>
    <button onclick="handleLogin()" class="btn btn-primary btn-action w-100">MULAI AKSES</button>
  </div>
</div>

<div id="instructionPage" class="container d-none py-5">
  <div class="question-card">
    <h3 class="fw-bold text-center mb-4">PETUNJUK UJIAN</h3>
    <div class="alert alert-info">Halo, <strong id="studentName"></strong>. Harap baca instruksi dengan teliti!</div>
    <ul class="list-group list-group-flush mb-4">
      <li class="list-group-item">1. Waktu pengerjaan adalah <strong>45 Menit</strong>.</li>
      <li class="list-group-item">2. Dilarang <strong>Pindah Tab, Minimize, atau Membuka Aplikasi lain</strong>.</li>
      <li class="list-group-item">3. Sistem mendeteksi <strong>Split Screen</strong>. Jika dilakukan, ujian akan dianggap selesai.</li>
      <li class="list-group-item">4. Soal akan tampil satu per satu secara acak.</li>
    </ul>
    <button onclick="startExam()" class="btn btn-primary btn-action w-100">SAYA MENGERTI, MULAI UJIAN</button>
  </div>
</div>

<div id="examPage" class="d-none">
  <div class="header-exam">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="header-title fw-bold">PA KATOLIK - XII</div>
      <div id="timer" class="timer-badge">45:00</div>
    </div>
  </div>
  
  <div class="container">
    <div class="question-card">
      <div id="qArea">
        </div>
      <div class="d-flex justify-content-between mt-4">
        <button id="btnPrev" onclick="move(-1)" class="btn btn-outline-secondary btn-action">Sebelumnya</button>
        <button id="btnNext" onclick="move(1)" class="btn btn-primary btn-action">Berikutnya</button>
      </div>
    </div>
  </div>
</div>

<div id="resultPage" class="container d-none py-5 text-center">
  <div class="question-card p-5">
    <h2 class="fw-bold text-success mb-3">UJIAN SELESAI</h2>
    <hr>
    <p class="mb-1">Nilai Akhir Anda:</p>
    <div id="finalScore" class="display-1 fw-bold mb-3" style="color: var(--primary)">0</div>
    <div id="cheatAlert" class="text-danger fw-bold mb-4"></div>
    <p class="text-muted">Data Anda telah dikirim ke Email Admin.</p>
  </div>
</div>

<script>
  let questions = [];
  let current = 0;
  let userAnswers = {};
  let timerSec = 3450;
  let isActive = false;
  let student = "";
  let cheatStatus = "Aman/Jujur";

  function handleLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if(u && p === "1234") {
      student = u;
      document.getElementById('studentName').innerText = u;
      document.getElementById('loginPage').classList.add('d-none');
      document.getElementById('instructionPage').classList.remove('d-none');
    } else { alert("Login gagal! Pastikan nama terisi dan password benar."); }
  }

  function startExam() {
    google.script.run.withSuccessHandler(data => {
      questions = data;
      isActive = true;
      document.getElementById('instructionPage').classList.add('d-none');
      document.getElementById('examPage').classList.remove('d-none');
      renderQuestion();
      startTimer();
      initSecurity();
    }).getQuestions();
  }

  function renderQuestion() {
    const q = questions[current];
    let html = `<p class="text-muted small">Soal No. ${current + 1} dari ${questions.length}</p>`;
    html += `<h5 class="fw-bold mb-4">${q.q}</h5>`;
    q.a.forEach((opt, i) => {
      const active = userAnswers[current] === i ? 'selected' : '';
      html += `<div class="option-item ${active}" onclick="selectOpt(${i})">
                <span class="me-3 fw-bold">${String.fromCharCode(65+i)}.</span> ${opt}
               </div>`;
    });
    document.getElementById('qArea').innerHTML = html;
    document.getElementById('btnPrev').style.visibility = current === 0 ? 'hidden' : 'visible';
    document.getElementById('btnNext').innerText = current === questions.length - 1 ? "SELESAI" : "BERIKUTNYA";
  }

  function selectOpt(i) { userAnswers[current] = i; renderQuestion(); }

  function move(dir) {
    if(dir === 1 && current === questions.length - 1) { 
      if(confirm("Apakah Anda yakin ingin menyelesaikan ujian?")) finishExam();
    } else {
      current += dir; renderQuestion();
    }
  }

  function startTimer() {
    const t = setInterval(() => {
      if(!isActive) clearInterval(t);
      let m = Math.floor(timerSec / 45);
      let s = timerSec % 45;
      document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
      if(timerSec <= 0) { clearInterval(t); finishExam(); }
      timerSec--;
    }, 1000);
  }

  // --- FITUR ANTI CURANG ---
  function initSecurity() {
    // Deteksi Pindah Tab / Minimize
    window.onblur = function() {
      if(isActive) {
        cheatStatus = "CURANG: Pindah Tab/Aplikasi";
        finishExam();
      }
    };

    // Deteksi Split Screen (Resizing mendadak)
    window.onresize = function() {
      if(isActive && (window.innerWidth < 450 || window.innerHeight < 450)) {
        cheatStatus = "CURANG: Deteksi Layar Terbelah/Resize";
        finishExam();
      }
    };
  }

  function finishExam() {
    if(!isActive) return;
    isActive = false;
    
    let correct = 0;
    questions.forEach((q, i) => {
      if(userAnswers[i] === q.c) correct++;
    });

    const score = ((correct / questions.length) * 100).toFixed(2);
    const payload = {
      nama: student,
      skorBenar: correct,
      totalSoal: questions.length,
      nilai: score,
      statusCurang: cheatStatus
    };

    google.script.run.withSuccessHandler(() => {
      document.getElementById('examPage').classList.add('d-none');
      document.getElementById('resultPage').classList.remove('d-none');
      document.getElementById('finalScore').innerText = score;
      if(cheatStatus !== "Aman/Jujur") {
        document.getElementById('cheatAlert').innerText = cheatStatus;
      }
    }).submitExam(payload);
  }
</script>
</body>
</html>
